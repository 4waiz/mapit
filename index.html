<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wayfinding Map ‚Äî EDGE Style</title>
  <style>
    :root{
      --edge-orange:#e09560;
      --edge-orange-d:#eb985c;
      --panel:#15181d;
      --panel-ink:#c7d0dc;
      --border:#262c34;
      --ink:#eef3fb;
      --muted:#8a96a8;
      --ink-soft:#c0c8d5;
      --route-bg:#2a3038;
      --logoH: 80px; /* user-mode logo height */

      /* ==== Animated Nebula Gradient (your colors) ==== */
      --nebula-start:#1c1d24;
      --nebula-mid-orange:#6e6560;
      --nebula-mid-grey:#2e3034;
      --nebula-end:#0c0d12;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      overflow:hidden; /* lock page scroll */
      background: conic-gradient(at 0% 50%,
        var(--nebula-start) 0%,
        var(--nebula-mid-orange) 20%,
        var(--nebula-start) 35%,
        var(--nebula-mid-grey) 65%,
        var(--nebula-start) 80%,
        var(--nebula-end) 100%);
      background-size:200% 200%;
      animation: panBackground 60s linear infinite alternate;
    }
    @keyframes panBackground{
      0%{background-position:0% 0%}
      100%{background-position:100% 100%}
    }

    /* ==== Mesh canvas sits under everything ==== */
    .bg-mesh{position:fixed; inset:0; z-index:0; overflow:hidden; pointer-events:none}
    #mesh{display:block; width:100%; height:100%}

    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh;height:100vh; position:relative; z-index:1}

    /* Header (hidden in user mode) */
    header{
      display:flex;gap:14px;align-items:center;justify-content:space-between;position:sticky;
      padding:18px 16px;border-bottom:1px solid var(--border);background:#0f1318;top:0;z-index:5
    }
    .brand{display:flex;align-items:center;gap:10px;position:absolute;left:50%;transform:translateX(-50%);pointer-events:none}
    .logo-img{height:80px;width:auto;display:block;object-fit:contain}

    /* Overlay logo for USER mode */
    .user-logo{
      position:fixed; top:10px; left:50%; transform:translateX(-50%);
      height:var(--logoH); z-index:4; display:none; pointer-events:none;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
    }
    body.user-only .user-logo{display:block;}

    /* Floating "Developer" button (only in user mode) */
    .dev-toggle{
      position:fixed; right:16px; bottom:16px; z-index:5; display:none;
      background:#141a22; color:#fff; border:1px solid var(--border);
      border-radius:999px; padding:10px 14px; cursor:pointer;
      box-shadow:0 4px 18px rgba(0,0,0,.35);
    }
    .dev-toggle:hover{background:#0f141b}
    body.user-only .dev-toggle{display:flex; align-items:center; gap:8px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#131920;gap:6px;color:var(--ink-soft)}
    label.switch{display:inline-grid;grid-template-columns:1fr 1fr;gap:2px;background:#0e1318;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    label.switch input{display:none}
    label.switch span{padding:6px 12px;cursor:pointer;user-select:none;color:var(--ink-soft)}
    label.switch input:checked + span{background:#141a22;color:#fff;}
    .status{color:var(--muted)}

    .btn{appearance:none;border:1px solid var(--border);border-radius:10px;background:#141a22;color:var(--ink);padding:8px 12px;cursor:pointer}
    .btn:hover{background:#0f141b}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn.primary{background:#ff6a00;border-color:#ff6a00;color:#111}
    .btn.primary:hover{background:#e65f00}
    .btn.warn{background:#2b1a00;border-color:#3a2300;color:#ffb266}
    .btn.danger{background:#2a0d0d;border-color:#3a1414;color:#ff8f8f}

    .layout{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;min-height:0;overflow:hidden}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    aside{background:#15181d;border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px;min-height:0;overflow:auto;color:#c7d0dc}
    aside h3{margin:6px 0 2px;font-size:12px;color:#cbd5e1;text-transform:uppercase;letter-spacing:.14em}
    .field{display:flex;flex-direction:column;gap:6px}
    select,input[type="text"]{width:100%;background:#0f141b;border:1px solid var(--border);color:#e5eefc;border-radius:10px;padding:8px}
    .vsep{height:1px;background:var(--border);margin:6px 0}
    .hint{color:#93a1b6;font-size:12px}
    .stack{display:flex;flex-direction:column;gap:6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .hidden{display:none !important}

    /* Map */
    .mapwrap{background:transparent;border:1px solid var(--border);border-radius:14px;position:relative;overflow:hidden;display:flex;flex-direction:column;gap:8px;padding:10px;min-height:0;height:100%}
    .mapbar{display:flex;justify-content:space-between;align-items:center;color:#aeb8c6}
    svg{width:100%;height:100%;min-height:0;border-radius:10px;background:transparent;flex:1 1 auto}

    /* Route & arrow */
    #routeBg{stroke:var(--route-bg);stroke-width:12;fill:none;stroke-linecap:round;stroke-linejoin:round}
    #route{stroke:url(#rainbowGrad);stroke-width:4;fill:none;stroke-linecap:round;stroke-linejoin:round;filter:drop-shadow(0 0 6px rgba(255,106,0,.25));stroke-dasharray:10 12;animation:dash 1.2s linear infinite}
    @keyframes dash{to{stroke-dashoffset:-220}}
    #draft{stroke:#9aa9be;stroke-dasharray:6 6;stroke-width:3;fill:none;stroke-linecap:round;stroke-linejoin:round}
    #arrow{filter:drop-shadow(0 2px 4px rgba(0,0,0,.45))}
    #arrow .head{fill:#ff6a00;stroke:#111;stroke-width:1}
    #arrow .tail{fill:#fff;opacity:.9}
    #arrow .pulse{fill:none;stroke:#ff6a00;stroke-width:2;opacity:.5}

    footer.small{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 16px;color:#9fb0c7;border-top:1px solid var(--border);background:#0f1318}

    /* USER mode: map only, leave a safe gap for logo */
    body.user-only header, body.user-only aside, body.user-only footer, body.user-only .mapbar{display:none!important}
    body.user-only .layout{grid-template-columns:1fr; padding:calc(var(--logoH) + 16px) 0 0 0}
    body.user-only .mapwrap{border:none;border-radius:0;padding:0}
    body.user-only svg{border-radius:0}
  </style>
</head>
<body>
  <!-- background mesh under content -->
  <div class="bg-mesh"><canvas id="mesh"></canvas></div>

  <!-- Visible only in USER mode -->
  <img src="logo.png" alt="Logo" class="user-logo" />
  <button class="dev-toggle" id="devToggle" title="Switch to Developer mode">üõ†Ô∏è Developer</button>

  <div class="app">
    <header>
      <div class="brand"><img src="logo.png" alt="Logo" class="logo-img" onerror="this.style.display='none'"></div>
      <div class="row">
        <div class="chip">
          <strong style="margin-right:6px">Mode</strong>
          <label class="switch">
            <input type="radio" name="mode" id="modeDev"><span>Developer</span>
            <input type="radio" name="mode" id="modeUser" checked><span>User</span>
          </label>
          <button class="btn" id="logoutDev" title="Lock Developer mode">Log out</button>
        </div>
        <div id="status" class="status">User mode: click a labeled area to go there. Start is <strong>You are here</strong>.</div>
      </div>
    </header>

    <div class="layout">
      <aside id="devPanel" class="hidden">
        <h3>Locations</h3>
        <div class="grid">
          <button class="btn" id="addPoint">+ Add point</button>
          <button class="btn" id="setHere">Set ‚ÄúYou are here‚Äù</button>
        </div>
        <div class="vsep"></div>
        <div class="field"><label for="fromSel">From</label><select id="fromSel"></select></div>
        <div class="field"><label for="toSel">To</label><select id="toSel"></select></div>
        <div class="grid"><button class="btn" id="btnDraw">Draw path</button><button class="btn" id="btnUndo" disabled>Undo</button></div>
        <div class="grid"><button class="btn primary" id="btnSave" disabled>Save route</button><button class="btn danger" id="btnDelete">Delete route</button></div>
        <div class="vsep"></div>
        <div class="grid"><button class="btn" id="btnExport">Export JSON</button><label class="btn" for="importFile">Import JSON</label><input id="importFile" class="hidden" type="file" accept="application/json" /></div>
        <div class="grid"><button class="btn warn" id="btnClearAll">Clear all</button><button class="btn" id="btnListRoutes">List routes</button></div>
        <div class="stack"><div class="hint">Tip: While drawing, click to add points. Press <span class="kbd">Enter</span> or click <em>Save route</em> to finish. <span class="kbd">Esc</span> cancels.</div></div>
      </aside>

      <main class="mapwrap">
        <div class="mapbar">
          <div class="legend"><span class="pill">Map</span><span>Click labels in <strong>User</strong> mode to navigate.</span></div>
          <div class="legend"><span class="pill">Pins</span><span class="pill">You are here</span></div>
        </div>

        <!-- SVG map: viewBox set dynamically to match image size -->
        <svg id="svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <!-- animated rainbow gradient -->
            <linearGradient id="rainbowGrad" gradientUnits="userSpaceOnUse" x1="0" y1="0" x2="400" y2="0">
              <stop offset="0%"  stop-color="#ff0000"><animate attributeName="stop-color" values="#ff0000;#ff7f00;#ffff00;#00ff00;#0000ff;#4b0082;#8f00ff;#ff0000" dur="8s" repeatCount="indefinite"/></stop>
              <stop offset="50%" stop-color="#00ff00"><animate attributeName="stop-color" values="#00ff00;#0000ff;#4b0082;#8f00ff;#ff0000;#ff7f00;#ffff00;#00ff00" dur="8s" repeatCount="indefinite"/></stop>
              <stop offset="100%" stop-color="#0000ff"><animate attributeName="stop-color" values="#0000ff;#4b0082;#8f00ff;#ff0000;#ff7f00;#ffff00;#00ff00;#0000ff" dur="8s" repeatCount="indefinite"/></stop>
              <animateTransform attributeName="gradientTransform" type="translate" from="-400 0" to="400 0" dur="6s" repeatCount="indefinite"/>
            </linearGradient>
          </defs>

          <image id="bg" href="image.png" x="0" y="0" width="100" height="100" preserveAspectRatio="xMidYMid meet" opacity="0.98" />
          <g id="pins"></g>
          <path id="routeBg" d=""></path>
          <path id="route" d=""></path>
          <path id="draft" d=""></path>
          <g id="arrow" transform="translate(-100,-100)">
            <circle class="pulse" r="0"><animate attributeName="r" values="0;20" dur="1.6s" repeatCount="indefinite"/><animate attributeName="opacity" values=".5;0" dur="1.6s" repeatCount="indefinite"/></circle>
            <path class="tail" d="M-10,-3 L-2,0 L-10,3 Z"/>
            <path class="head" d="M0,-6 L16,0 L0,6 L3,0 Z"/>
          </g>
        </svg>
      </main>
    </div>

    <footer class="small">
      <div class="credit">Created by Awaiz Ahmed</div><div></div>
    </footer>
  </div>

  <script>
  /* ---------- mesh background (subtle, performant) ---------- */
  (function(){
    const canvas = document.getElementById('mesh');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    let w=0,h=0,dpr=1, nodes=[], maxLinks=110, nodeCount=0;
    const MAX_D = 140;     // link radius (px)
    const DOT_R = 1.5;     // dot radius (px)
    const SPEED = 0.06;    // base speed (px/ms)
    let last=0, hueBase=210;

    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      w = canvas.clientWidth;
      h = canvas.clientHeight;
      canvas.width = w*dpr;
      canvas.height = h*dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);

      // number of nodes scales with area (cap for perf)
      nodeCount = Math.max(40, Math.min(120, Math.floor((w*h)/18000)));
      spawnNodes();
    }
    function spawnNodes(){
      nodes = new Array(nodeCount).fill(0).map(()=>({
        x: Math.random()*w,
        y: Math.random()*h,
        vx:(Math.random()*2-1)*SPEED,
        vy:(Math.random()*2-1)*SPEED
      }));
    }
    function step(ts){
      if(!last) last = ts;
      const dt = ts - last; last = ts;

      // soft clear
      ctx.clearRect(0,0,w,h);
      // drift hue slightly over time (cool‚Üíwarm‚Üícool)
      const hue = (hueBase + (ts/80))%360;

      // move
      for(const n of nodes){
        n.x += n.vx * dt;
        n.y += n.vy * dt;
        if(n.x<0||n.x>w) n.vx*=-1;
        if(n.y<0||n.y>h) n.vy*=-1;
      }

      // connections
      ctx.lineWidth = 1;
      let links = 0;
      for(let i=0;i<nodes.length;i++){
        const a = nodes[i];
        for(let j=i+1;j<nodes.length;j++){
          const b = nodes[j];
          const dx=a.x-b.x, dy=a.y-b.y;
          const d = Math.hypot(dx,dy);
          if(d<MAX_D){
            const alpha = (1 - d/MAX_D) * 0.18; // subtle
            ctx.strokeStyle = `hsla(${hue}, 30%, 75%, ${alpha})`;
            ctx.beginPath();
            ctx.moveTo(a.x,a.y);
            ctx.lineTo(b.x,b.y);
            ctx.stroke();
            if(++links>nodeCount*3 || links>maxLinks) break;
          }
        }
      }

      // dots
      ctx.fillStyle = 'rgba(255,255,255,0.15)';
      for(const n of nodes){
        ctx.beginPath();
        ctx.arc(n.x, n.y, DOT_R, 0, Math.PI*2);
        ctx.fill();
      }

      requestAnimationFrame(step);
    }

    // init
    resize();
    requestAnimationFrame(step);
    window.addEventListener('resize', resize);
  })();

  (function(){
    const LS_ROUTES='wf_routes_v1', LS_MARKERS='wf_markers_v1', LS_YOU='wf_you_pos_v1', YOU_KEY='YOU';
    let ROUTES=JSON.parse(localStorage.getItem(LS_ROUTES)||'{}');
    let MARKERS=JSON.parse(localStorage.getItem(LS_MARKERS)||'{}');
    let YOU_POS=JSON.parse(localStorage.getItem(LS_YOU)||'null');
    let devUnlocked=false;

    const $=q=>document.querySelector(q);
    const svg=$('#svg'), pinsLayer=$('#pins'), route=$('#route'), routeBg=$('#routeBg'), draft=$('#draft'), arrow=$('#arrow');
    const fromSel=$('#fromSel'), toSel=$('#toSel'), statusEl=$('#status'), devPanel=$('#devPanel');
    const modeDev=$('#modeDev'), modeUser=$('#modeUser'), logoutDev=$('#logoutDev'), devToggle=$('#devToggle'), bg=$('#bg');
    const addPointBtn=$('#addPoint'), setHereBtn=$('#setHere'), btnDraw=$('#btnDraw'), btnUndo=$('#btnUndo'), btnSave=$('#btnSave');
    const btnDelete=$('#btnDelete'), btnExport=$('#btnExport'), importFile=$('#importFile'), btnClearAll=$('#btnClearAll'), btnListRoutes=$('#btnListRoutes');

    let mode='user', placing=null, drawing=false, points=[], anim=null;

    function setStatus(html){ statusEl && (statusEl.innerHTML=html); }
    function saveRoutes(){ localStorage.setItem(LS_ROUTES, JSON.stringify(ROUTES)); }
    function saveMarkers(){ localStorage.setItem(LS_MARKERS, JSON.stringify(MARKERS)); }
    function saveYou(){ YOU_POS? localStorage.setItem(LS_YOU, JSON.stringify(YOU_POS)) : localStorage.removeItem(LS_YOU); }
    const keyFor=(f,t)=>f+'‚Üí'+t;
    function svgPoint(e){const pt=svg.createSVGPoint(); if(e.touches&&e.touches[0]){pt.x=e.touches[0].clientX; pt.y=e.touches[0].clientY;}else{pt.x=e.clientX; pt.y=e.clientY;} return pt.matrixTransform(svg.getScreenCTM().inverse());}
    function drawPathD(list){ if(!list||!list.length) return ''; const a=list[0]; return 'M '+a.x+' '+a.y+' L '+list.map(p=>p.x+' '+p.y).join(' '); }
    function clearRoute(){ route.setAttribute('d',''); routeBg.setAttribute('d',''); draft.setAttribute('d',''); if(anim) cancelAnimationFrame(anim); arrow.setAttribute('transform','translate(-100,-100)'); }

    function fitToImage(){
      const img=new Image();
      img.onload=()=>{ const W=img.naturalWidth||768, H=img.naturalHeight||1344; svg.setAttribute('viewBox',`0 0 ${W} ${H}`); bg.setAttribute('width',W); bg.setAttribute('height',H); };
      img.src=bg.getAttribute('href');
    }
    fitToImage();

    // Mode switching
    modeDev && modeDev.addEventListener('change',()=>setMode(modeDev.checked?'dev':'user'));
    modeUser && modeUser.addEventListener('change',()=>setMode(modeUser.checked?'user':'dev'));
    devToggle && devToggle.addEventListener('click',()=>setMode('dev'));
    logoutDev && logoutDev.addEventListener('click',()=>{devUnlocked=false; modeUser&&(modeUser.checked=true); setMode('user');});

    function login(){ const u=prompt('Username:'), p=prompt('Password:'); return (u==='awaiz' && p==='1234'); }
    function setMode(m){
      if(m==='dev' && !devUnlocked){ if(!login()){ alert('Access denied.'); modeUser&&(modeUser.checked=true); m='user'; } else { devUnlocked=true; } }
      mode=m;
      document.body.classList.toggle('user-only', m==='user');
      devPanel && devPanel.classList.toggle('hidden', m!=='dev');
      logoutDev && logoutDev.classList.toggle('hidden', m!=='dev');
      (fromSel?.parentElement||{}).classList?.toggle('hidden', m!=='dev');
      (toSel?.parentElement||{}).classList?.toggle('hidden', m!=='dev');
      setStatus(m==='user' ? 'User mode: click a labeled area to go there. Start is <strong>You are here</strong>.' : 'Developer mode: add points, set start, draw and save routes.');
      clearRoute(); renderPins();
      modeDev && (modeDev.checked = m==='dev');
      modeUser && (modeUser.checked = m==='user');
    }

    function fillSelects(){
      if(!fromSel || !toSel) return;
      fromSel.innerHTML=''; toSel.innerHTML='';
      const addOpt=(el,val,txt)=>{const o=document.createElement('option');o.value=val;o.textContent=txt;el.appendChild(o);}
      addOpt(fromSel,'YOU','You are here');
      Object.keys(MARKERS).sort().forEach(n=>{addOpt(fromSel,n,n); addOpt(toSel,n,n);});
      fromSel.value='YOU'; toSel.value='';
    }

    function ns(tag){return document.createElementNS('http://www.w3.org/2000/svg',tag)}
    function renderPins(){
      pinsLayer.innerHTML='';
      for(const [name,p] of Object.entries(MARKERS)){
        const g=ns('g'); g.setAttribute('transform',`translate(${p.x},${p.y})`);
        const c=ns('circle'); c.setAttribute('r',8); c.style.fill='#ffffff18'; c.style.stroke='#cbd5e1';
        const t=ns('text'); t.setAttribute('x',12); t.setAttribute('y',4); t.textContent=name; t.setAttribute('fill','#e5eefc'); t.setAttribute('stroke','#0b0d10'); t.setAttribute('stroke-width','2');
        g.append(c,t);
        g.addEventListener('click',()=>{ if(mode==='dev' && placing) return; if(mode==='user'){navigateTo(name);} else {toSel.value=name; setStatus('Selected destination: <b>'+name+'</b>.'); showRoute(fromSel.value||'YOU', name);} });
        pinsLayer.appendChild(g);
      }
      if(YOU_POS){
        const g=ns('g'); g.setAttribute('transform',`translate(${YOU_POS.x},${YOU_POS.y})`);
        const c=ns('circle'); c.setAttribute('r',9); c.style.fill='#ffdcb8'; c.style.stroke='#ff6a00';
        const t=ns('text'); t.setAttribute('x',12); t.setAttribute('y',4); t.textContent='You are here'; t.setAttribute('fill','#e5eefc'); t.setAttribute('stroke','#0b0d10'); t.setAttribute('stroke-width','2');
        g.append(c,t); pinsLayer.appendChild(g);
      }
    }

    function showRoute(fromKey,toKey){
      clearRoute(); if(!fromKey||!toKey) return;
      const arr=ROUTES[keyFor(fromKey,toKey)];
      if(!arr || !arr.length){ if(mode==='user') setStatus('No saved route from <b>You are here</b> to <b>'+toKey+'</b>.'); return; }
      const d=drawPathD(arr); route.setAttribute('d',d); routeBg.setAttribute('d',d);
      setStatus('Showing saved route <b>'+label(fromKey)+'</b> ‚Üí <b>'+label(toKey)+'</b>.'); animateAlong(route);
    }
    const label=k=>k==='YOU'?'You are here':k;

    function animateAlong(path){
      const L=path.getTotalLength(); let t0=null; const dur=Math.max(2000,L*4);
      function step(ts){ if(!t0) t0=ts; const dlen=((ts-t0)%dur)/dur*L; const pos=path.getPointAtLength(dlen); const ahead=path.getPointAtLength(Math.min(dlen+2,L)); const ang=Math.atan2(ahead.y-pos.y,ahead.x-pos.x)*180/Math.PI; arrow.setAttribute('transform',`translate(${pos.x},${pos.y}) rotate(${ang})`); anim=requestAnimationFrame(step); }
      if(anim) cancelAnimationFrame(anim); anim=requestAnimationFrame(step);
    }

    function navigateTo(name){ if(!YOU_POS){ setStatus('Set <b>You are here</b> in Developer mode first.'); return; } setStatus('Destination selected: <b>'+name+'</b>.'); showRoute('YOU', name); }

    // Dev actions
    addPointBtn && addPointBtn.addEventListener('click',()=>{ if(mode!=='dev') return; placing='point'; setStatus('Add point: click the map where the label should be.'); });
    setHereBtn && setHereBtn.addEventListener('click',()=>{ if(mode!=='dev') return; placing='here'; setStatus('Set ‚ÄúYou are here‚Äù: click the map.'); });
    btnDraw && btnDraw.addEventListener('click',()=>{ if(mode!=='dev') return; const to=toSel.value; if(!to){ setStatus('Choose a destination in <b>To</b> first.'); return; } drawing=true; points=[]; btnUndo.disabled=false; btnSave.disabled=false; draft.setAttribute('d',''); setStatus('Drawing route‚Ä¶ Click to add points, <span class="kbd">Enter</span> to finish.'); });
    btnUndo && btnUndo.addEventListener('click',()=>{ if(!drawing||!points.length) return; points.pop(); draft.setAttribute('d',drawPathD(points)); });
    btnSave && btnSave.addEventListener('click',()=>{ if(!drawing||!points.length){ setStatus('Nothing to save.'); return; } const from=fromSel.value||'YOU', to=toSel.value; ROUTES[keyFor(from,to)]=points.slice(); saveRoutes(); drawing=false; btnUndo.disabled=true; btnSave.disabled=true; draft.setAttribute('d',''); setStatus('Saved route.'); showRoute(from,to); });
    btnDelete && btnDelete.addEventListener('click',()=>{ const from=fromSel.value||'YOU', to=toSel.value; if(!to){ setStatus('Select a destination.'); return; } const k=keyFor(from,to); if(ROUTES[k]){ if(confirm('Delete saved route?')){ delete ROUTES[k]; saveRoutes(); clearRoute(); setStatus('Deleted.'); } } else setStatus('No saved route.'); });
    btnExport && btnExport.addEventListener('click',()=>{ const data={markers:MARKERS,you:YOU_POS,routes:ROUTES,meta:{exportedAt:new Date().toISOString(),version:1}}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='wayfinding-data.json'; a.click(); URL.revokeObjectURL(url); });
    importFile && importFile.addEventListener('change',async e=>{ const f=e.target.files[0]; if(!f) return; try{ const data=JSON.parse(await f.text()); MARKERS=data.markers||{}; YOU_POS=data.you||null; ROUTES=data.routes||{}; saveMarkers(); saveYou(); saveRoutes(); fillSelects(); renderPins(); clearRoute(); setStatus('Imported.'); }catch{ alert('Invalid JSON file.'); } importFile.value=''; });
    btnClearAll && btnClearAll.addEventListener('click',()=>{ if(!confirm('Clear all?')) return; MARKERS={}; YOU_POS=null; ROUTES={}; localStorage.removeItem(LS_MARKERS); localStorage.removeItem(LS_YOU); localStorage.removeItem(LS_ROUTES); fillSelects(); renderPins(); clearRoute(); setStatus('All data cleared.'); });
    btnListRoutes && btnListRoutes.addEventListener('click',()=>{ const keys=Object.keys(ROUTES); alert(keys.length? 'Saved routes:\n'+keys.map(k=>k.replace('‚Üí',' ‚Üí ')).join('\n') : 'No routes saved yet.'); });

    // Map click for placing/drawing
    svg.addEventListener('click',e=>{
      const p=svgPoint(e);
      if(placing){
        if(placing==='point'){
          const name=prompt('Enter location name (e.g., Reception)');
          if(name && name.trim() && name!=='You are here' && name!=='YOU'){ MARKERS[name.trim()]={x:Math.round(p.x),y:Math.round(p.y)}; saveMarkers(); fillSelects(); renderPins(); setStatus('Added point: <b>'+name.trim()+'</b>.'); }
        }else if(placing==='here'){ YOU_POS={x:Math.round(p.x), y:Math.round(p.y)}; saveYou(); renderPins(); setStatus('Set <b>You are here</b>.'); }
        placing=null; return;
      }
      if(drawing){ points.push({x:Math.round(p.x),y:Math.round(p.y)}); draft.setAttribute('d',drawPathD(points)); }
    });

    // Keys while drawing
    window.addEventListener('keydown',e=>{
      if(!drawing) return;
      if(e.key==='Escape'){ drawing=false; points=[]; draft.setAttribute('d',''); btnUndo.disabled=true; btnSave.disabled=true; setStatus('Drawing cancelled.'); }
      else if(e.key==='Enter'){ btnSave.click(); }
      else if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='z'){ btnUndo.click(); }
    });

    // Init (default User mode)
    fillSelects();
    renderPins();
    document.body.classList.add('user-only');
    modeUser && (modeUser.checked=true);
    setStatus('User mode: click a labeled area to go there. Start is <strong>You are here</strong>.');
  })();
  </script>
</body>
</html>
