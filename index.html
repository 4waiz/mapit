<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mapit – Firebase Sync (Dev/User safe)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#0f1217; --panel:#131821; --ink:#e8eefc; --muted:#8fa0bd; --accent:#5da0ff;
      --danger:#ff5d7a; --ok:#34d399; --border:#223049;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--ink);
      font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
      display:flex; flex-direction:column;
    }
    header {
      display:flex; gap:.5rem; align-items:center; padding:.6rem .8rem;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    header .spacer { flex:1 }
    button, .chip {
      background:#182133; color:var(--ink); border:1px solid var(--border);
      padding:.4rem .7rem; border-radius:.55rem; cursor:pointer;
    }
    button:hover { border-color:#2b3c5e }
    input[type="file"] { display:none }
    label.file { cursor:pointer }
    .chip { color:var(--muted); }
    .chip.active { color:var(--ink); border-color:var(--accent) }
    .right { margin-left:auto }
    #canvasWrap { position:relative; flex:1; overflow:auto; }
    #board {
      position:relative; width:1600px; height:900px; margin:1rem auto;
      background:#0d1524 url('https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat;
      border:1px solid var(--border); border-radius:12px;
    }
    svg.routes { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }
    .pin, .you {
      position:absolute; transform:translate(-50%,-100%);
      padding:.2rem .35rem; background:#1b2740; border:1px solid var(--border);
      border-radius: 8px; white-space:nowrap; font-size:12px;
    }
    .pin::before, .you::before {
      content:""; position:absolute; left:50%; bottom:-6px; width:0; height:0; transform:translateX(-50%);
      border-left:6px solid transparent; border-right:6px solid transparent; border-top:6px solid #1b2740;
    }
    .pin .dot { display:inline-block; width:8px; height:8px; border-radius:999px; background:var(--accent); margin-right:.35rem; }
    .you { background:#10311f; border-color:#1d5d3b }
    .you::before { border-top-color:#10311f }
    .legend { position:absolute; right:12px; bottom:12px; background:#0f1628; border:1px solid var(--border); padding:.6rem .8rem; border-radius:10px; color:var(--muted) }
    .hint { color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <strong>Mapit</strong>
    <span class="chip" id="modeChip">Mode: <b>user</b></span>
    <button id="toggleMode">Switch to Dev</button>
    <button id="unlockDev" title="Unlock dev actions">Unlock</button>
    <span class="spacer"></span>

    <label class="file"><input id="importFile" type="file" accept="application/json"/>Import JSON</label>
    <button id="exportJson">Export JSON</button>
    <span class="spacer"></span>

    <button id="addMarker">Add Marker</button>
    <button id="setYou">Set “You”</button>
    <button id="startRoute">Draw Route</button>
    <button id="saveRoute">Save Route</button>
    <button id="clearRoute">Clear Route</button>
  </header>

  <div id="canvasWrap">
    <div id="board">
      <svg class="routes" id="routeSvg"></svg>
      <!-- pins are injected here -->
      <div class="legend">
        <div class="hint">Dev: add pins/you/draw route, then save.</div>
        <div class="hint">User: view & interact only.</div>
      </div>
    </div>
  </div>

  <!-- Firebase (compat so legacy firebase.firestore() works) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // =========================
    //  Firebase initialization
    // =========================
    // TODO: paste your Firebase config here from the console
    // const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", ... };
    const firebaseConfig = {
      apiKey: "AIzaSyDqwJLEhoTUI8qiUHnoSMioq4oQhTAgmks",
      authDomain: "mapit-e2534.firebaseapp.com",
      projectId: "mapit-e2534",
      storageBucket: "mapit-e2534.firebasestorage.app",
      messagingSenderId: "584091763757",
      appId: "1:584091763757:web:6aff9a34a807b4e3c024a4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const mapDocRef = db.collection("maps").doc("main-map-data");

    // =========================
    //  State
    // =========================
    let MARKERS = {};  // { id: {x,y,label} }
    let ROUTES  = {};  // { id: [ {x,y}, ... ] }
    let YOU_POS = null; // {x,y}

    let mode = 'user';
    let devUnlocked = false;

    // drawing helpers
    let placing = null;        // 'marker' | 'you' | null
    let drawing = false;       // route drawing mode
    let currentRoutePoints = [];
    let routeCounter = 1;

    // versioning (prevents stale snapshot from clobbering fresh import/save)
    let lastWriteVersion = 0;

    // =========================
    //  DOM helpers
    // =========================
    const board = document.getElementById('board');
    const svg = document.getElementById('routeSvg');
    const modeChip = document.getElementById('modeChip');

    function px(val) { return Math.round(val) + 'px'; }

    function boardPos(e) {
      const rect = board.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top)  / rect.height;
      return { x: Math.max(0,Math.min(1,x)), y: Math.max(0,Math.min(1,y)) };
    }

    // =========================
    //  Local cache
    // =========================
    function persistLocal() {
      try {
        localStorage.setItem('mapit-data', JSON.stringify({ markers: MARKERS, routes: ROUTES, you: YOU_POS }));
      } catch {}
    }
    function loadFromLocal() {
      try {
        const raw = localStorage.getItem('mapit-data');
        if (!raw) return;
        const d = JSON.parse(raw);
        MARKERS = d.markers || {};
        ROUTES  = d.routes  || {};
        YOU_POS = d.you || null;
      } catch {}
    }

    // =========================
    //  Rendering
    // =========================
    function clearPins() {
      [...board.querySelectorAll('.pin, .you')].forEach(n => n.remove());
    }

    function renderPins() {
      clearPins();
      // you
      if (YOU_POS) {
        const el = document.createElement('div');
        el.className = 'you';
        el.textContent = 'You';
        el.style.left = px(YOU_POS.x * board.clientWidth);
        el.style.top  = px(YOU_POS.y * board.clientHeight);
        board.appendChild(el);
      }
      // markers
      Object.entries(MARKERS).forEach(([id, m]) => {
        const el = document.createElement('div');
        el.className = 'pin';
        el.innerHTML = `<span class="dot"></span>${m.label || id}`;
        el.style.left = px(m.x * board.clientWidth);
        el.style.top  = px(m.y * board.clientHeight);
        board.appendChild(el);
      });
    }

    function renderRoutes() {
      svg.innerHTML = '';
      Object.values(ROUTES).forEach(points => {
        if (!Array.isArray(points) || points.length < 2) return;
        const d = points.map((p, i) => `${i ? 'L':'M'} ${p.x*100} ${p.y*100}`).join(' ');
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('vector-effect','non-scaling-stroke');
        path.setAttribute('fill','none');
        path.setAttribute('stroke-width','3');
        // leave stroke color to default (tooling rule)
        svg.appendChild(path);
      });
      // current (unsaved) route being drawn
      if (drawing && currentRoutePoints.length >= 1) {
        const d = currentRoutePoints.map((p, i) => `${i ? 'L':'M'} ${p.x*100} ${p.y*100}`).join(' ');
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('vector-effect','non-scaling-stroke');
        path.setAttribute('fill','none');
        path.setAttribute('stroke-width','2');
        svg.appendChild(path);
      }
    }

    function renderAll() { renderRoutes(); renderPins(); }

    // =========================
    //  Firestore I/O (versioned)
    // =========================
    function saveDataToFirebase(force=false) {
      if ((mode !== 'dev' || !devUnlocked) && !force) return;
      const ver = Date.now();
      lastWriteVersion = ver;
      persistLocal();
      return mapDocRef.set(
        {
          markers: MARKERS,
          routes: ROUTES,
          you: YOU_POS,
          version: ver,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        },
        { merge: true }
      ).catch(err => {
        console.error('Save error:', err);
        alert('Cloud save failed. Data kept locally.');
      });
    }

    function loadData() {
      mapDocRef.onSnapshot(doc => {
        if (!doc.exists) { renderAll(); return; }
        const data = doc.data() || {};

        // Ignore stale snapshots
        if (data.version && lastWriteVersion && data.version < lastWriteVersion) return;

        MARKERS = data.markers || {};
        ROUTES  = data.routes  || {};
        YOU_POS = data.you || null;

        persistLocal();
        renderAll();
      }, err => console.error('Snapshot error:', err));
    }

    // =========================
    //  UI interactions
    // =========================
    document.getElementById('toggleMode').addEventListener('click', () => {
      mode = (mode === 'user') ? 'dev' : 'user';
      document.getElementById('toggleMode').textContent = mode === 'dev' ? 'Switch to User' : 'Switch to Dev';
      modeChip.innerHTML = `Mode: <b>${mode}</b>`;
    });

    document.getElementById('unlockDev').addEventListener('click', () => {
      if (mode !== 'dev') { alert('Switch to Dev first.'); return; }
      devUnlocked = !devUnlocked;
      document.getElementById('unlockDev').textContent = devUnlocked ? 'Lock' : 'Unlock';
    });

    // place marker
    document.getElementById('addMarker').addEventListener('click', () => {
      if (mode !== 'dev' || !devUnlocked) return alert('Unlock in Dev mode to add markers.');
      placing = 'marker';
    });

    // set "you"
    document.getElementById('setYou').addEventListener('click', () => {
      if (mode !== 'dev' || !devUnlocked) return alert('Unlock in Dev mode to set position.');
      placing = 'you';
    });

    // draw route
    document.getElementById('startRoute').addEventListener('click', () => {
      if (mode !== 'dev' || !devUnlocked) return alert('Unlock in Dev mode to draw routes.');
      drawing = true;
      currentRoutePoints = [];
      renderRoutes();
    });

    document.getElementById('saveRoute').addEventListener('click', () => {
      if (!drawing || currentRoutePoints.length < 2) return alert('Draw at least two points.');
      if (!ROUTES || typeof ROUTES !== 'object') ROUTES = {};
      const id = 'route-' + (routeCounter++);
      ROUTES[id] = currentRoutePoints.slice();
      drawing = false;
      currentRoutePoints = [];
      renderRoutes();
      saveDataToFirebase(); // normal save (dev+unlocked)
    });

    document.getElementById('clearRoute').addEventListener('click', () => {
      drawing = false; currentRoutePoints = []; renderRoutes();
    });

    // board click handler
    board.addEventListener('click', (e) => {
      const p = boardPos(e);
      if (placing === 'marker') {
        const id = 'pin-' + Math.random().toString(36).slice(2,7);
        MARKERS[id] = { x:p.x, y:p.y, label:'Pin' };
        placing = null;
        renderPins();
        saveDataToFirebase();
        return;
      }
      if (placing === 'you') {
        YOU_POS = { x:p.x, y:p.y };
        placing = null;
        renderPins();
        saveDataToFirebase();
        return;
      }
      if (drawing) {
        currentRoutePoints.push(p);
        renderRoutes();
      }
    });

    // =========================
    //  Import / Export
    // =========================
    document.getElementById('exportJson').addEventListener('click', () => {
      const payload = { markers: MARKERS, routes: ROUTES, you: YOU_POS || null };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'wayfinding-data.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('importFile').addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      f.text().then(text => {
        const data = JSON.parse(text);
        MARKERS = data.markers || {};
        ROUTES  = (data.routes && typeof data.routes === 'object') ? data.routes : {};
        YOU_POS = data.you || null;

        persistLocal();
        renderAll();
        // Force save so user mode sees the imported data immediately
        saveDataToFirebase(true);
      }).catch(() => alert('Invalid JSON'));
      e.target.value = '';
    });

    // =========================
    //  Boot
    // =========================
    loadFromLocal();
    renderAll();
    loadData();
  </script>
</body>
</html>
