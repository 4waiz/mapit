<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EDGE LIF — Simple Wayfinder</title>
<style>
  :root{--bg:#0b111b;--panel:#0f1626;--b:#22314e;--text:#eaf1ff;--muted:#9fb0cc;--pink:#ff61d8;--cyan:#6af0ff;}
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:14px}
  .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .brand{font-weight:900;letter-spacing:.04em}
  .brand-logo{height:56px;display:block}
  .panel{display:grid;grid-template-columns:minmax(320px,360px) 1fr;gap:12px}
  .card{background:var(--panel);border:1px solid var(--b);border-radius:14px;padding:14px}
  label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:4px}
  select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--b);background:#0e1524;color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
  .note{font-size:.9rem;color:var(--muted);margin-top:8px}
  .mapBox{position:relative}
  svg.map{width:100%;height:70vh;max-height:80dvh;display:block;border-radius:14px}
  .hint{font-size:.9rem;color:var(--muted)}
  @media (max-width:980px){.panel{grid-template-columns:1fr} .actions{grid-template-columns:repeat(2,1fr)} .row{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <img src="logo.png" alt="EDGE LIF logo" class="brand-logo">
  </div>
  <div class="panel">
    <div class="card">
      <div class="row">
        <div>
          <label>From</label>
          <select id="from">
            <option value="" selected>— Select —</option>
            <option value="reception">Reception</option>
            <option value="lobby">Lobby</option>
            <option value="room1">Training A</option>
            <option value="room2">Training B</option>
            <option value="conference">Conference</option>
            <option value="exit">Exit</option>
          </select>
        </div>
        <div>
          <label>To</label>
          <select id="to">
            <option value="" selected>— Select —</option>
            <option value="exit">Exit</option>
            <option value="reception">Reception</option>
            <option value="lobby">Lobby</option>
            <option value="room1">Training A</option>
            <option value="room2">Training B</option>
            <option value="conference">Conference</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="draw">Draw route</button>
        <button id="undo" disabled>Undo point</button>
        <button id="save" disabled>Save for pair</button>
        <button id="clearPair" disabled>Clear saved pair</button>
        <button id="clearAll">Clear ALL saved</button>
      </div>
      <div class="note" id="status">Pick From & To, then click "Draw route" and trace the corridor. Press Save when done.</div>
    </div>

    <div class="card mapBox">
      <svg id="map" class="map" viewBox="0 0 1307 768" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1200" y2="0" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="var(--cyan)"/><stop offset="100%" stop-color="var(--pink)"/>
          </linearGradient>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="4" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          </defs>
          <image href="Image.png" x="0" y="0" width="1307" height="768" opacity=".95"/>
          <!-- saved route -->
        <path id="routeBg" d="" fill="none" stroke="#22314e" stroke-width="12" stroke-linecap="round" stroke-linejoin="round" opacity=".7"/>
        <path id="route" d="" fill="none" stroke="url(#g)" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" filter="url(#glow)"/>
        <!-- drawing preview -->
        <polyline id="preview" points="" fill="none" stroke="url(#g)" stroke-width="6" stroke-dasharray="8,8" style="display:none"/>
        <!-- arrow -->
        <g id="arrow" style="display:none" filter="url(#glow)">
          <polygon points="0,0 -18,-10 -18,10" fill="#ffd54a" stroke="#0b111b" stroke-width="0.7" vector-effect="non-scaling-stroke"/>
        </g>
      </svg>
      <div class="hint">Tip: zoom with browser zoom (Ctrl/Cmd + +/–). Works up to 8K displays.</div>
    </div>
  </div>
</div>

<script>
const svg = document.getElementById('map');
const route = document.getElementById('route');
const routeBg = document.getElementById('routeBg');
const preview = document.getElementById('preview');
const arrow = document.getElementById('arrow');
const fromSel = document.getElementById('from');
const toSel = document.getElementById('to');
const statusEl = document.getElementById('status');
const drawBtn = document.getElementById('draw');
const undoBtn = document.getElementById('undo');
const saveBtn = document.getElementById('save');
const clearPairBtn = document.getElementById('clearPair');
const clearAllBtn = document.getElementById('clearAll');

// storage
let ROUTES = JSON.parse(localStorage.getItem('wf_routes')||'{}');
function pk(){ return fromSel.value && toSel.value ? fromSel.value + '->' + toSel.value : null; }

// drawing state
let drawing=false, pts=[];

function setStatus(msg){ statusEl.textContent = msg; }
function setPreview(){ preview.setAttribute('points', pts.map(p=>p.join(',')).join(' ')); }
function updatePairButtons(){
  const hasPair = !!(fromSel.value && toSel.value);
  clearPairBtn.disabled = !hasPair || !ROUTES[pk()];
}

function roundedPath(points, r){
  if(points.length<2) return '';
  let d='M ' + points[0][0] + ' ' + points[0][1];
  for(let i=1;i<points.length-1;i++){
    const pPrev=points[i-1], p=points[i], pNext=points[i+1];
    const v1=[pPrev[0]-p[0], pPrev[1]-p[1]], v2=[pNext[0]-p[0], pNext[1]-p[1]];
    const m1=Math.hypot(v1[0],v1[1]), m2=Math.hypot(v2[0],v2[1]);
    const u1=[v1[0]/m1, v1[1]/m1], u2=[v2[0]/m2, v2[1]/m2];
    const dot=u1[0]*u2[0]+u1[1]*u2[1];
    if(Math.abs(dot)>0.999){ d+=' L '+p[0]+' '+p[1]; continue; }
    const a=Math.min(r, Math.hypot(p[0]-pPrev[0],p[1]-pPrev[1])/2);
    const b=Math.min(r, Math.hypot(p[0]-pNext[0],p[1]-pNext[1])/2);
    const p1=[p[0]+u1[0]*a, p[1]+u1[1]*a];
    const p2=[p[0]+u2[0]*b, p[1]+u2[1]*b];
    d+=' L '+p1[0]+' '+p1[1]+' Q '+p[0]+' '+p[1]+' '+p2[0]+' '+p2[1];
  }
  const last=points[points.length-1];
  d+=' L '+last[0]+' '+last[1];
  return d;
}

function render(){
  const key = pk();
  arrow.style.display='none';
  route.setAttribute('d',''); routeBg.setAttribute('d','');
  if(!key || !ROUTES[key]){ setStatus('No saved route for this pair. Click "Draw route" to create one.'); updatePairButtons(); return; }
  const pts = ROUTES[key];
  const d = roundedPath(pts, 20);
  route.setAttribute('d', d); routeBg.setAttribute('d', d);
  setStatus('Showing saved route. Click "Draw route" to update.');
  updatePairButtons();
  animateArrow();
}

function animateArrow(){
  const total = route.getTotalLength();
  if(!total) return;
  route.style.strokeDasharray = total;
  route.style.strokeDashoffset = total;
  const t0 = performance.now(), dur = 2200;
  function frame(now){ const t = Math.min((now-t0)/dur, 1); const len = total*(0.2 + 0.8*t); route.style.strokeDashoffset = total-len;
    const p  = route.getPointAtLength(Math.max(0,len-1));
    const p2 = route.getPointAtLength(Math.min(total,len+1));
    const ang = Math.atan2(p2.y-p.y, p2.x-p.x)*180/Math.PI;
    arrow.setAttribute('transform', 'translate('+p.x+','+p.y+') rotate('+ang+')');
    arrow.style.display='block';
    if(t<1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

// UI events
[fromSel,toSel].forEach(el=> el.addEventListener('change', render));

drawBtn.addEventListener('click', ()=>{
  if(!(fromSel.value && toSel.value)){ setStatus('Pick From & To first.'); return; }
  drawing=true; pts=[]; preview.style.display='block'; setPreview();
  undoBtn.disabled=false; saveBtn.disabled=false;
  setStatus('Drawing: click along the corridor. Save when done. (Esc to cancel)');
});

undoBtn.addEventListener('click', ()=>{
  if(!drawing || pts.length===0) return;
  pts.pop(); setPreview();
});

function savePair(){
  const key = pk();
  if(!key || pts.length<2){ setStatus('Add at least 2 points.'); return; }
  ROUTES[key] = pts.slice();
  localStorage.setItem('wf_routes', JSON.stringify(ROUTES));
  drawing=false; preview.style.display='none'; undoBtn.disabled=true; saveBtn.disabled=true;
  setStatus('Saved.'); render();
}
saveBtn.addEventListener('click', savePair);

clearPairBtn.addEventListener('click', ()=>{
  const key = pk(); if(!key) return;
  delete ROUTES[key]; localStorage.setItem('wf_routes', JSON.stringify(ROUTES));
  setStatus('Cleared saved route for this pair.'); render();
});

clearAllBtn.addEventListener('click', ()=>{
  if(!confirm('Delete ALL saved routes?')) return;
  ROUTES = {}; localStorage.removeItem('wf_routes');
  setStatus('All saved routes cleared.'); render();
});

// drawing on svg
window.addEventListener('keydown', (e)=>{
  if(e.key==='Escape' && drawing){ drawing=false; preview.style.display='none'; undoBtn.disabled=true; saveBtn.disabled=true; setStatus('Canceled drawing.'); }
});
svg.addEventListener('click', (e)=>{
  if(!drawing) return;
  const pt = svg.createSVGPoint(); pt.x=e.clientX; pt.y=e.clientY;
  const p = pt.matrixTransform(svg.getScreenCTM().inverse());
  pts.push([Math.round(p.x), Math.round(p.y)]); setPreview();
});

// initial
render();
</script>
</body>
</html>
